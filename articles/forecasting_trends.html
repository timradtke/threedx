<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="threedx">
<title>Forecasting Trends with `threedx` • threedx</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Forecasting Trends with `threedx`">
<meta property="og:description" content="threedx">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">threedx</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/threedx.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/forecasting_trends.html">Forecasting Trends with `threedx`</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/timradtke/threedx/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Forecasting Trends with `threedx`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timradtke/threedx/blob/HEAD/vignettes/articles/forecasting_trends.Rmd" class="external-link"><code>vignettes/articles/forecasting_trends.Rmd</code></a></small>
      <div class="d-none name"><code>forecasting_trends.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">637</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/timradtke/threedx" class="external-link">threedx</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The <code>threedx</code> model is not designed to forecast trends in
time series. As its predictions are a pure weighted average of
historical observations, the model does not extrapolate beyond the
limits of the historical data. Nevertheless, one can choose the
<strong>innovation function</strong> used during generation of the
forecast paths to capture the systematic error of the model.</p>
<p>To demonstrate the issue, let’s start with a simple trending time
series that clearly continues to trend upward and has fairly little
noise, and no trend component.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2019-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-12-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">60</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_train</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-01-01"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">df_test</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-01-01"</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/plot_example_trend-1.png" width="700"></p>
<p>The best <code>threedx</code> can do, with no trend component to
speak of, is to base the next observation to nearly the full extent on
the most recent observation. When one can’t predict the trend,
predicting the same level from the previous observation is the best one
can do. The forecast is a straight line, while the actuals continue to
rise:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">df_train</span><span class="op">$</span><span class="va">y</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu"><a href="../reference/list_sampled_alphas.html">list_sampled_alphas</a></span><span class="op">(</span>include_edge_cases <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_mae</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">model</span>,</span>
<span>  horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  innovation_function <span class="op">=</span> <span class="va">draw_normal_with_zero_mean</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">df_train</span><span class="op">$</span><span class="va">date</span>, date_future <span class="op">=</span> <span class="va">df_test</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-15"</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/forecast_trend-1.png" width="700"></p>
<p>If we inspect the model, we see that the one-step-ahead residuals
have a clear bias (positive mean and median) as the model doesn’t
predict the on-average increase month-over-month:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's </span></span>
<span><span class="co">#&gt; -1.8954 -0.4693  0.5569  0.6218  1.4752  2.9873      12</span></span></code></pre></div>
<p>We can make use of this bias in the residuals at prediction time.</p>
<p>By choosing an innovation function that does not enforce a zero-mean
assumption on the innovation samples projected into the future (as
standard implementations of forecasting approaches such as ARIMA and ETS
do), we can add this bias onto the forecast, and thereby offset the
model’s bias.</p>
<p>Using <code><a href="../reference/draw_normal_with_drift.html">draw_normal_with_drift()</a></code> will use the sample mean
of the residuals to draw innovations (in contrast to the hardcoded mean
at zero used in <code><a href="../reference/draw_normal_with_zero_mean.html">draw_normal_with_zero_mean()</a></code> above):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">model</span>,</span>
<span>  horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  innovation_function <span class="op">=</span> <span class="va">draw_normal_with_drift</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">df_train</span><span class="op">$</span><span class="va">date</span>, date_future <span class="op">=</span> <span class="va">df_test</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-15"</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/forecast_with_drift-1.png" width="700"></p>
<p>We can also drop the normality assumption and bootstrap entirely from
residuals (which here doesn’t make a big difference as the time series
was generated from a Normal distribution):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">model</span>,</span>
<span>  horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  innovation_function <span class="op">=</span> <span class="va">draw_bootstrap</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">df_train</span><span class="op">$</span><span class="va">date</span>, date_future <span class="op">=</span> <span class="va">df_test</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-12-15"</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/forecast_with_bootstrap-1.png" width="700"></p>
<div class="section level2">
<h2 id="the-innovation-function-is-not-a-panacea">The Innovation Function Is Not A Panacea<a class="anchor" aria-label="anchor" href="#the-innovation-function-is-not-a-panacea"></a>
</h2>
<p>While the choice of the innovation function is a remedy for the
missing trend component in the above example, it doesn’t work quite as
neatly in all cases.</p>
<p>By using an innovation function that doesn’t enforce a zero-mean, the
forecast can be improved for time series that consist of a strong and
mostly linear trend.</p>
<p>However, if the trend is not as uniform across past observations, or
if there are seasonal components as well, the forecast can be much
trickier.</p>
<p>As soon as the model tries to compensate the trend in some way during
training (instead of using an <code>alpha</code> close to 1), and
thereby messes up a clean prediction of the seasonal component, there is
not much that can be fixed by the innovation function choice.</p>
<p>Consider the following extreme example to make the problem tangible.
We will forecast a monthly seasonal time series that trends upward with
every year by three additional units. To make the relationship between
trend, model, and residuals clear, we don’t add any noise component:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">component_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">5</span>,<span class="fl">4</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span></span>
<span><span class="va">component_trend</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">60</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">component_season</span> <span class="op">+</span> <span class="va">component_trend</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/plot_example_trend_and_season-1.png" width="700"></p>
<p>First, note that <code>threedx</code> can forecast the seasonal
component perfectly if it’s the <em>only</em> component:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">threedx</span><span class="fu">::</span><span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">component_season</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu"><a href="../reference/list_sampled_alphas.html">list_sampled_alphas</a></span><span class="op">(</span>include_edge_cases <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_mae</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>    horizon <span class="op">=</span> <span class="fl">24L</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>    observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    innovation_function <span class="op">=</span> <span class="va">draw_normal_with_zero_mean</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/forecast_component_season-1.png" width="700"></p>
<p>However, when trend and seasonality are combined, the model training
results in an unfortunate parameter choice that relinquishes the perfect
seasonality prediction to accompany the trend in a desperate
fashion.</p>
<p>The reason for this is the loss function: The mean absolute error
(used here via <code><a href="../reference/loss_mae.html">loss_mae()</a></code>) is reduced by trading off the
error due to the trend with the error due to the seasonality. It does
not accept the bias in the one-step-ahead predictions that would remain
due to the trend for models that predict the seasonality perfectly.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">threedx</span><span class="fu">::</span><span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">y</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu"><a href="../reference/list_sampled_alphas.html">list_sampled_alphas</a></span><span class="op">(</span>include_edge_cases <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_mae</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>    horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>    observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    innovation_function <span class="op">=</span> <span class="va">draw_normal_with_drift</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/forecast_trend_and_season-1.png" width="700"></p>
<p>We can recover the optimal model choice (in combination with the
drifting innovation function) by using a loss function that ignores the
bias. Let’s redefine the mean absolute error, removing the mean
bias:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loss_mae_ignoring_bias</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y_hat</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">residuals</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">y_hat</span></span>
<span>  <span class="va">residuals_zero_bias</span> <span class="op">&lt;-</span> <span class="va">residuals</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">residuals</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">residuals_zero_bias</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Using <code><a href="../reference/loss_mae_ignoring_bias.html">loss_mae_ignoring_bias()</a></code> instead of
<code><a href="../reference/loss_mae.html">loss_mae()</a></code>, the model that perfectly removes the seasonal
error is chosen as the trend bias is ignored during training. During
prediction, the bias is compensated by the innovations with drift.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">threedx</span><span class="fu">::</span><span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">y</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu"><a href="../reference/list_sampled_alphas.html">list_sampled_alphas</a></span><span class="op">(</span>include_edge_cases <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_mae_ignoring_bias</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>    horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>    observation_driven <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    innovation_function <span class="op">=</span> <span class="va">draw_normal_with_drift</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="forecasting_trends_files/figure-html/train_with_loss_mae_ignoring_bias-1.png" width="700"></p>
<p>But again, this is unlikely to be a panacea.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tim Radtke.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
