<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="threedx">
<title>Define Custom Innovation Functions • threedx</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Define Custom Innovation Functions">
<meta property="og:description" content="threedx">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">threedx</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/threedx.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/forecasting_trends.html">Forecasting Trends with `threedx`</a>
    <a class="dropdown-item" href="../articles/define_custom_innovation_functions.html">Define Custom Innovation Functions</a>
    <a class="dropdown-item" href="../articles/define_custom_loss_functions.html">Define Custom Loss Functions</a>
    <a class="dropdown-item" href="../articles/generating_diverse_weights.html">Generating Diverse Weights for Training</a>
    <a class="dropdown-item" href="../articles/working_with_forecast_sample_paths.html">Working with Forecast Sample Paths</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/timradtke/threedx/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Define Custom Innovation Functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timradtke/threedx/blob/HEAD/vignettes/define_custom_innovation_functions.Rmd" class="external-link"><code>vignettes/define_custom_innovation_functions.Rmd</code></a></small>
      <div class="d-none name"><code>define_custom_innovation_functions.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">857</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/timradtke/threedx" class="external-link">threedx</a></span><span class="op">)</span></span></code></pre></div>
<p>Like <a href="https://otexts.com/fpp3/ets.html" class="external-link">Innovations-State-Space Models
(ISSM)</a>, a <code>threedx</code> model requires an
innovation-generating process to produce forecast distributions. That
is, we need to define some process that generates values by which we can
perturb the point forecasts in order to represent the uncertainty in our
predictions.</p>
<p>For many types of forecast models, and likewise for
<code>threedx</code>, the main way to specify such process is as a
function of the one-step-ahead residuals from the model training.</p>
<p>After fitting a model, …</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, mean <span class="op">=</span> <span class="fl">100</span>, sd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu"><a href="../reference/list_edge_alphas.html">list_edge_alphas</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_rmse</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>… residuals can be accessed from the fitted model object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="va">residuals</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span><span class="co">#&gt; [13]  -2.9 -26.1  -4.3  30.4 -28.2  25.8  -1.7  -4.5 -27.5  36.8 -11.4 -10.7</span></span>
<span><span class="co">#&gt; [25]  30.8  -2.8 -49.5   8.2 -10.5  25.3 -24.9  21.1 -16.0  12.2 -11.1  -8.9</span></span>
<span><span class="co">#&gt; [37]   8.6  -9.0  23.6   9.2 -25.3  -4.3  -2.2  11.9 -17.5 -33.3 -16.7  11.4</span></span>
<span><span class="co">#&gt; [49]  17.1 -41.5</span></span></code></pre></div>
<p>Since residuals summarize the error the model made on the training
set, it is the best information we have to inform the errors it is
likely to make on the test set (but overfitting!).</p>
<p>With the residuals in hand, we have everything to generate some
future errors or innovations that will drive the forecast sample
paths.</p>
<p>A common innovation function would be the one that draws innovations
from a Normal distribution with a mean of zero and with the empirical
standard deviation of the residuals as standard deviation, which comes
with <code>threedx</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">draw_normal_with_zero_mean</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (n, errors, ...) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     checkmate::assert_integerish(x = n, lower = 1, any.missing = FALSE, </span></span>
<span><span class="co">#&gt;         len = 1)</span></span>
<span><span class="co">#&gt;     checkmate::assert_numeric(x = errors, finite = TRUE, any.missing = FALSE)</span></span>
<span><span class="co">#&gt;     suppressWarnings(stats::rnorm(n = n, mean = 0, sd = stats::sd(errors)))</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55f9e69ae168&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:threedx&gt;</span></span></code></pre></div>
<p>Every innovation function requires at least two function arguments
that are passed by <code><a href="../reference/predict.threedx.html">predict.threedx()</a></code>: The number
<code>n</code> of independent samples to draw, and the numeric vector of
(non-missing) residuals <code>errors</code> of length greater than zero.
Note that <code>n</code> has nothing in common with the length of
<code>errors</code>.</p>
<p>Instead, the provided <code>n</code> is equal to the forecast
<code>horizon</code> times the number of sample paths
<code>n_samples</code> to be generated. The innovation function is used
to draw an innovation for each future time step for each sample
path.</p>
<p>Consequently, the expected output is a numeric vector of length
<code>n</code> of non-missing, independent samples.</p>
<div class="section level2">
<h2 id="independence-of-innovations">Independence of Innovations<a class="anchor" aria-label="anchor" href="#independence-of-innovations"></a>
</h2>
<p>In <code><a href="../reference/predict.threedx.html">predict.threedx()</a></code>, the <em>independently</em> drawn
innovations are used to construct sample paths iteratively.</p>
<p>The first <code>n_samples</code> innovations are added on top of the
point prediction for horizon one. The resulting <code>n_samples</code>
potential future observations are then combined with the past
observations and weighted by the model weights to generate the point
prediction for horizon two.</p>
<p>Next, the second batch of <code>n_samples</code> innovations are
added to the point prediction for horizon two, and the process
repeats.</p>
<p>Because of this iterative behavior, each sample path will exhibit
autocorrelation depending on the fitted model—despite the original
innovations being independent samples. At the same time, the different
sample paths are independent of each other.</p>
</div>
<div class="section level2">
<h2 id="a-bit-of-inspiration">A Bit of Inspiration<a class="anchor" aria-label="anchor" href="#a-bit-of-inspiration"></a>
</h2>
<p>Because the residuals are provided, one can use them to draw a
non-parametric bootstrap:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">draw_bootstrap</span><span class="op">)</span></span>
<span><span class="co">#&gt; function (n, errors, ...) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     checkmate::assert_integerish(x = n, lower = 1, any.missing = FALSE, </span></span>
<span><span class="co">#&gt;         len = 1)</span></span>
<span><span class="co">#&gt;     checkmate::assert_numeric(x = errors, finite = TRUE, any.missing = FALSE, </span></span>
<span><span class="co">#&gt;         min.len = 1)</span></span>
<span><span class="co">#&gt;     if (length(errors) == 1L) {</span></span>
<span><span class="co">#&gt;         return(rep(errors, times = n))</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     sample(x = errors, size = n, replace = TRUE, prob = NULL)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55f9e6b4e590&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:threedx&gt;</span></span></code></pre></div>
<p>And since the errors are provided in chronological order, you can use
their index for arbitrary things: You could sample based on the errors
of the most recent period only, or assign weights to the residuals
before sampling, as done in <code><a href="../reference/draw_bootstrap_weighted.html">draw_bootstrap_weighted()</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tim Radtke.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
