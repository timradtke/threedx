<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="threedx">
<title>Working with Forecast Sample Paths • threedx</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with Forecast Sample Paths">
<meta property="og:description" content="threedx">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">threedx</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/threedx.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/forecasting_trends.html">Forecasting Trends with `threedx`</a>
    <a class="dropdown-item" href="../articles/define_custom_innovation_functions.html">Define Custom Innovation Functions</a>
    <a class="dropdown-item" href="../articles/define_custom_loss_functions.html">Define Custom Loss Functions</a>
    <a class="dropdown-item" href="../articles/generating_diverse_weights.html">Generating Diverse Weights for Training</a>
    <a class="dropdown-item" href="../articles/working_with_forecast_sample_paths.html">Working with Forecast Sample Paths</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/timradtke/threedx/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Working with Forecast Sample Paths</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/timradtke/threedx/blob/HEAD/vignettes/working_with_forecast_sample_paths.Rmd" class="external-link"><code>vignettes/working_with_forecast_sample_paths.Rmd</code></a></small>
      <div class="d-none name"><code>working_with_forecast_sample_paths.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">636</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/timradtke/threedx" class="external-link">threedx</a></span><span class="op">)</span></span></code></pre></div>
<p>Forecast sample paths are the best. In contrast to quantiles, you can
aggregate them!</p>
<p>Most forecast model implementations only aim to provide select
quantiles of the forecast distribution to quantify the forecast
uncertainty—if at all. While this suffices for applications that are
strictly defined and will not extend their use case in the future,
quantiles can be very restrictive in a business context where one needs
to perform arbitrary and often unforeseen aggregations across time
horizons, hierarchies, and the like.</p>
<p>If you only have quantiles, you can’t do it. Quantiles can’t be
aggregated.</p>
<p>Maybe you can rely on an assumption of independent Normal
distributions, and sum those. But auto-correlation would get lost.</p>
<p>In contrast, sample paths are neat because they provide a
representation of the joint forecast distribution over time horizons. In
contrast to marginal quantiles, you can first aggregate sample paths in
arbitrary ways, and <em>then take quantiles</em> to summarize the
distribution of an arbitrary aggregation of interest.</p>
<p>Let’s fit a model…</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">55</span>, lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span> <span class="op">+</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sinpi</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">59</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">threedx</span><span class="fu">::</span><span class="fu"><a href="../reference/learn_weights.html">learn_weights</a></span><span class="op">(</span></span>
<span>  y <span class="op">=</span> <span class="va">y</span>,</span>
<span>  period_length <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  alphas_grid <span class="op">=</span> <span class="fu">threedx</span><span class="fu">::</span><span class="fu"><a href="../reference/list_sampled_alphas.html">list_sampled_alphas</a></span><span class="op">(</span></span>
<span>    n_target <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>    include_edge_cases <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  loss_function <span class="op">=</span> <span class="va">loss_mae</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>… and generate forecast sample paths:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">model</span>,</span>
<span>  horizon <span class="op">=</span> <span class="fl">12L</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="fl">2500L</span>,</span>
<span>  observation_driven <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The forecasts are stored in a <code>threedx_paths</code> object,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "threedx_paths"</span></span></code></pre></div>
<p>of which the main component is a matrix of sample paths (each row is
a sample path, each column a forecast horizon):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># printing only the first 5 of `n_samples` sample paths</span></span>
<span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12]</span></span>
<span><span class="co">#&gt; [1,]    2    8    7   13    6    1    1    0    0     0     1     0</span></span>
<span><span class="co">#&gt; [2,]    5   11   11   13    6    2    0    0    0     0     0     2</span></span>
<span><span class="co">#&gt; [3,]    3    8    7    7    2    0    0    0    0     1     0     0</span></span>
<span><span class="co">#&gt; [4,]    3   11    8   11    1    0    0    0    0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    5   12   13   13    2    0    0    0    0     0     0     1</span></span></code></pre></div>
<div class="section level3">
<h3 id="summarize-over-sample-paths">Summarize Over Sample Paths<a class="anchor" aria-label="anchor" href="#summarize-over-sample-paths"></a>
</h3>
<p>To summarize the forecast at each horizon, we can compute the
mean…</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  5.9  9.8  9.5 11.0  5.3  1.1  0.1  0.0  0.0  0.2  0.3  1.3</span></span></code></pre></div>
<p>… or any quantile…</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span>, <span class="fl">2</span>, <span class="va">quantile</span>, <span class="fl">0.9</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 10 12 11 14  7  2  0  0  0  1  1  2</span></span></code></pre></div>
<p>… or ask specific questions such as “what is the probability of an
observation larger than zero?”:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0.97 1.00 1.00 1.00 0.97 0.60 0.05 0.01 0.02 0.19 0.24 0.59</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="summarize-over-horizons">Summarize Over Horizons<a class="anchor" aria-label="anchor" href="#summarize-over-horizons"></a>
</h3>
<p>Similarly, we can summarize along the <code>n_samples</code>
dimension of the matrix.</p>
<p>We can ask for the total value across all horizons by sample
path…</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 39 50 28 34 46</span></span></code></pre></div>
<p>… or for the total value in the six-month period after horizon
three…</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span></span>
<span>  <span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 21 21  9 12 15</span></span></code></pre></div>
<p>… or how many of the next twelve months will exhibit a value of
zero:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span></span>
<span>  <span class="va">forecast</span><span class="op">$</span><span class="va">paths</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 4 5 6 7 6</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="summarize-over-horizons-and-sample-paths">Summarize Over Horizons And Sample Paths<a class="anchor" aria-label="anchor" href="#summarize-over-horizons-and-sample-paths"></a>
</h3>
<p>Usually, we want to follow up an aggregation across horizons by an
aggregation across sample paths.</p>
<p>We can get the median sum for the next twelve months…</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 44</span></span></code></pre></div>
<p>… the 95% quantile for the six-month period after horizon three…</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; 95% </span></span>
<span><span class="co">#&gt;  27</span></span></code></pre></div>
<p>… or the probability of zero value at horizons 7 through 9:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">$</span><span class="va">paths</span><span class="op">[</span>, <span class="fl">7</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9268</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-sample-path-forecasts">Visualize Sample Path Forecasts<a class="anchor" aria-label="anchor" href="#visualize-sample-path-forecasts"></a>
</h2>
<p>If you have <code>ggplot2</code> installed, <code>threedx</code>
provides two ways of visualizing a <code>threedx_paths</code> object
using the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code> method.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The default is a graph of marginal quantiles of the sample paths for
each forecast horizon as many other forecast packages would provide
it:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">)</span></span></code></pre></div>
<p><img src="working_with_forecast_sample_paths_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>An alternative option specified via the argument
<code>method = "paths"</code> is the visualization of individual sample
paths as lines. Since a graph of sample paths becomes very crowded very
quickly, by default only <code>n = 5</code> randomly chosen paths are
plotted:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">forecast</span>, method <span class="op">=</span> <span class="st">"paths"</span><span class="op">)</span></span></code></pre></div>
<p><img src="working_with_forecast_sample_paths_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>While forecast quantiles sometimes give the impression that a model
expects a flat line of future observations. Visualizations of sample
paths make clear that any given future scenario is anything but a flat
line.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tim Radtke.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
